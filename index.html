<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login with metamask</title>
    <script
      src="https://code.jquery.com/jquery-3.6.0.min.js"
      integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
      crossorigin="anonymous"
    ></script>
    <script src="https://unpkg.com/@metamask/detect-provider/dist/detect-provider.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.3/web3.min.js"
      integrity="sha512-Ws+qbaGHSFw2Zc1e7XRpvW+kySrhmPLFYTyQ95mxAkss0sshj6ObdNP3HDWcwTs8zBJ60KpynKZywk0R8tG1GA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
  </head>
  <body>
    <h1>Login with metamask</h1>
    <div>
      <p id="info"></p>
      <button id="login">Login with metamask</button>
      <button id="logout">Logout</button>
    </div>
  </body>
</html>
<script>
  jQuery(document).ready(async ($) => {
    const infoText = $("#info");
    const loginButton = $("#login");
    const logoutButton = $("#logout");

    // Function to connect MetaMask and perform login
    const connectMetaMask = async () => {
      try {
        infoText.text("Connecting MetaMask...");

        // 1 - Connect MetaMask with the frontend
        const provider = await detectEthereumProvider();
        if (!provider) {
          throw new Error("MetaMask is not installed!");
        }

        await provider.enable();
        infoText.text("MetaMask connected!");

        // 2 - Get the wallet address from MetaMask
        const web3 = new Web3(provider);
        const walletAddress = await web3.eth.getCoinbase();
        if (!walletAddress) {
          throw new Error("Wallet address not found in MetaMask");
        }

        // 3 - Send the wallet address to the server to get a nonce
        const response1 = await fetch(`/nonce?walletAddress=${walletAddress}`);
        if (!response1.ok) {
          throw new Error(`Error fetching nonce: ${response1.statusText}`);
        }
        const { nonce } = await response1.json();

        // 4 - Sign the nonce with MetaMask
        const signedNonce = await web3.eth.personal.sign(nonce, walletAddress);

        // 5 - Send the signed nonce to the server for verification
        const response2 = await fetch(
          `/verify?walletAddress=${walletAddress}&signedNonce=${signedNonce}`
        );
        if (!response2.ok) {
          throw new Error(`Error verifying signature: ${response2.statusText}`);
        }
        const { success } = await response2.json();

        if (success) {
          // If login successful, update UI and check session status
          alert("Login successful!");
          await checkSession();
        } else {
          throw new Error("Login failed");
        }
      } catch (error) {
        // Handle errors and display messages
        console.error("Error during MetaMask connection and login:", error);
        infoText.text(`Error: ${error.message}`);
      }
    };

    // Function to handle logout
    const logout = async () => {
      try {
        infoText.text("Logging out, please wait...");
        const response = await fetch("/logout");
        if (!response.ok) {
          throw new Error(`Error logging out: ${response.statusText}`);
        }
        await checkSession();
      } catch (error) {
        console.error("Error during logout:", error);
        infoText.text(`Error: ${error.message}`);
      }
    };

    // Function to check session status
    const checkSession = async () => {
      try {
        infoText.text("Checking session...");

        const response = await fetch("/check");
        if (!response.ok) {
          throw new Error(`Error checking session: ${response.statusText}`);
        }

        const data = await response.json();
        const { success, walletAddress } = data;

        if (success) {
          // If logged in, update UI accordingly
          logoutButton.show();
          loginButton.hide();
          infoText.text(`You are logged in with your wallet: ${walletAddress}`);
        } else {
          // If not logged in, update UI accordingly
          logoutButton.hide();
          loginButton.show();
          infoText.text("You are currently not logged in with MetaMask");
        }
      } catch (error) {
        console.error("Error checking session:", error);
        infoText.text(`Error: ${error.message}`);
      }
    };

    // Initial check of session status on page load
    await checkSession();

    // Event listener for login button
    loginButton.on("click", async () => {
      await connectMetaMask();
    });

    // Event listener for logout button
    logoutButton.on("click", async () => {
      await logout();
    });
  });
</script>

<!-- <script>
  jQuery(document).ready(($) => {
    const infoText = $("#info");
    const loginButton = $("#login");
    const logoutButton = $("#logout");

    loginButton.on("click", async () => {
      // 1 - connect metamask with the frontend

      infoText.text("connecting metamask!!");

      const provider = await detectEthereumProvider();

      if (!provider) {
        return infoText.text("metamask is not installed!!!");
      }

      await provider.enable();
      infoText.text("metamask connected!!");

      // 2 - get the wallet address from metamask

      const web3 = new Web3(provider);
      const walletAddress = await web3.eth.getCoinbase();
      console.log('walletAddress', walletAddress)
      // 3 - send the wallet address to the server

      const response1 = await fetch(`/nonce?walletAddress=${walletAddress}`);
      console.log('// 3 - send the wallet address to the server, response1', response1)
      const { nonce } = await response1.json();
      console.log('nonce', nonce)
      // 4 - get the nonce and sign it

      const signedNonce = await web3.eth.personal.sign(nonce, walletAddress);
      console.log('signedNonce', signedNonce)
      // 5 - send the nonce to the server

      const response2 = await fetch(
        `/verify?walletAddress=${walletAddress}&signedNonce=${signedNonce}`
      );
      console.log('// 5 - send the nonce to the server,response2 ', response2)
      
      const { success } = await response2.json();
      console.log('send the nonce to the server - success', success)
      await checkSession();
    });

    logoutButton.on("click", async () => {
      infoText.text("Logging out, please wait!");
      const response = await fetch("/logout");
      await checkSession();
    });

    const checkSession = async () => {
      infoText.text("checking session!");
      const response = await fetch("/check");
      console.log('response', response)
    
      const data = await response.json();
      const { success, walletAddress } = data;
      console.log('data', data)
      console.log('success', success)
      console.log('walletAddress', walletAddress)
      
      if (success) {
        logoutButton.show();
        loginButton.hide();
        infoText.text("You are logged in with your wallet: " + walletAddress);
      } else {
        logoutButton.hide();
        loginButton.show();
        infoText.text("You are currently not logged in with metamask");
      }
    };
    checkSession();
  });
  
  
  
  
</script> -->